<!DOCTYPE html>
<html>
<head>
    <title>Direction Arrow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        #compass {
            width: 200px;
            height: 200px;
            margin: 40px auto;
            position: relative;
        }
        #arrow {
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 100px solid red;
            position: absolute;
            left: 80px;
            top: 50px;
            transform-origin: 50% 100%;
            transition: transform 0.1s ease-out;
        }
        #info {
            margin-top: 30px;
            font-size: 1.2em;
        }
        #calibration-warning {
            color: red;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Direction Finder</h1>
    <div id="compass">
        <div id="arrow"></div>
    </div>
    <div id="info">
        <div id="distance">--</div>
        <div id="calibration-warning">Move your phone in a figure-8 pattern to calibrate</div>
    </div>

    <script>
        // Configuration - Set your target location here
        const TARGET_LOCATION = {
            lat: 40.7128,  // New York City as example
            lon: -74.0060
        };

        // DOM Elements
        const arrowElement = document.getElementById('arrow');
        const distanceElement = document.getElementById('distance');
        const calibrationWarning = document.getElementById('calibration-warning');

        // State variables
        let currentPosition = null;
        let currentHeading = null;

        // Initialize
        function init() {
            // Request permissions on iOS 13+ devices
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                document.body.addEventListener('click', function() {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                startSensors();
                            }
                        })
                        .catch(console.error);
                });
            } else {
                startSensors();
            }
        }

        // Start all sensor listeners
        function startSensors() {
            // Start GPS
            if ('geolocation' in navigator) {
                navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    handlePositionError,
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                alert("Geolocation not supported");
            }

            // Start compass
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                alert("Compass not supported");
            }
        }

        // Handle position updates
        function handlePositionUpdate(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lon: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            updateUI();
        }

        function handlePositionError(error) {
            console.error("GPS Error:", error.message);
        }

        // Handle orientation updates
        function handleOrientation(event) {
            // Check for iOS/Android differences
            if (event.webkitCompassHeading !== undefined) {
                // Chrome/Safari
                currentHeading = event.webkitCompassHeading;
                if (event.webkitCompassAccuracy > 15) {
                    calibrationWarning.style.display = 'block';
                } else {
                    calibrationWarning.style.display = 'none';
                }
            } else if (event.absolute !== undefined && event.alpha !== null) {
                // Firefox/other browsers
                currentHeading = 360 - event.alpha;
            }
            updateUI();
        }

        // Update the arrow and distance display
        function updateUI() {
            if (!currentPosition || currentHeading === null) return;

            // Calculate bearing to target
            const bearing = calculateBearing(
                currentPosition.lat, currentPosition.lon,
                TARGET_LOCATION.lat, TARGET_LOCATION.lon
            );

            // Calculate relative angle between heading and bearing
            let arrowAngle = (bearing - currentHeading + 360) % 360;
            
            // Rotate the arrow
            arrowElement.style.transform = `rotate(${arrowAngle}deg)`;

            // Calculate and display distance
            const distance = calculateDistance(
                currentPosition.lat, currentPosition.lon,
                TARGET_LOCATION.lat, TARGET_LOCATION.lon
            );
            
            distanceElement.textContent = `Distance: ${distance.toFixed(0)} meters`;
        }

        // Calculate bearing from point A to B (in degrees)
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) -
                      Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
            let θ = Math.atan2(y, x);
            return (θ*180/Math.PI + 360) % 360;
        }

        // Calculate distance between two points (in meters)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Start the app
        init();
    </script>
</body>
</html>